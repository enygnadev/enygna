'use client';

import React, { useState, useEffect } from 'react';
import Link from 'next/link';
import { auth, db } from '@/src/lib/firebase';
import { onAuthStateChanged, signOut, createUserWithEmailAndPassword, updateProfile } from 'firebase/auth';
import { doc, getDoc, collection, addDoc, getDocs, query, where, serverTimestamp, setDoc, updateDoc } from 'firebase/firestore';
import ThemeSelector from '@/src/components/ThemeSelector';
import { useRouter } from 'next/navigation'; // Import useRouter

interface Veiculo {
  id: string;
  placa: string;
  renavam: string;
  marca: string;
  modelo: string;
  ano: number;
  cor: string;
  condutor: string;
  status: 'ativo' | 'manutencao' | 'inativo' | 'em_viagem';
  pais: string;
  cidade: string;
  multas: number;
  valorMultas: number;
  vencimentoIPVA: string;
  vencimentoLicenciamento: string;
  kmRodados: number;
  consumoMedio: number;
  ultimaManutencao: string;
  proximaManutencao: string;
  seguro: {
    vencimento: string;
    valor: number;
    seguradora: string;
  };
  gps: {
    latitude: number;
    longitude: number;
    ultimaAtualizacao: string;
  };
  combustivel: {
    nivel: number;
    tipo: string;
    custoMes: number;
  };
}

interface FleetStats {
  totalVeiculos: number;
  veiculosAtivos: number;
  multasPendentes: number;
  motoristasCadastrados: number;
  totalDebitos: number;
  kmTotalMes: number;
  consumoTotalCombustivel: number;
  custosManutencao: number;
}

export default function FrotaPage() {
  const router = useRouter(); // Initialize router
  const [user, setUser] = useState<any>(null);
  const [loading, setLoading] = useState(true);
  const [hasAccess, setHasAccess] = useState(false);
  const [userPermissions, setUserPermissions] = useState<any>(null);
  const [veiculos, setVeiculos] = useState<Veiculo[]>([]);
  const [filteredVeiculos, setFilteredVeiculos] = useState<Veiculo[]>([]);
  const [stats, setStats] = useState<FleetStats>({
    totalVeiculos: 0,
    veiculosAtivos: 0,
    multasPendentes: 0,
    motoristasCadastrados: 0,
    totalDebitos: 0,
    kmTotalMes: 0,
    consumoTotalCombustivel: 0,
    custosManutencao: 0,
  });

  // Estados de controle
  const [selectedCountry, setSelectedCountry] = useState(0);
  const [statusFilter, setStatusFilter] = useState('todos');
  const [searchTerm, setSearchTerm] = useState('');
  const [selectedVehicle, setSelectedVehicle] = useState<Veiculo | null>(null);
  const [detailsModalOpen, setDetailsModalOpen] = useState(false);
  const [editMode, setEditMode] = useState(false);
  const [addVehicleModal, setAddVehicleModal] = useState(false);
  const [aiAnalysisModal, setAiAnalysisModal] = useState(false);
  const [newVehicle, setNewVehicle] = useState<Partial<Veiculo>>({});
  const [aiInsights, setAiInsights] = useState<{id:number,titulo:string,descricao:string,prioridade:string,confianca:number,economia_estimada:string,risk_score:number}[]>([]);
  const [snackbar, setSnackbar] = useState<{open:boolean,message:string,type:'success'|'error'}>({ open: false, message: '', type: 'success' });

  // Estados para modal de adicionar colaborador
  const [showAddColaboradorModal, setShowAddColaboradorModal] = useState(false);
  const [newColaborador, setNewColaborador] = useState({
    nome: '',
    email: '',
    senha: ''
  });
  const [isAddingColaborador, setIsAddingColaborador] = useState(false);

  // Estados para modal de adicionar ve√≠culo
  const [showAddVehicleModal, setShowAddVehicleModal] = useState(false);
  const [newVehicleData, setNewVehicleData] = useState({
    marca: '',
    modelo: '',
    placa: '',
    ano: '',
    cor: ''
  });
  const [isAddingVehicle, setIsAddingVehicle] = useState(false);

  // Estados para atribuir colaborador
  const [showAtribuirModal, setShowAtribuirModal] = useState(false);
  const [veiculoParaAtribuir, setVeiculoParaAtribuir] = useState<Veiculo | null>(null);
  const [colaboradoresDisponiveis, setColaboradoresDisponiveis] = useState<any[]>([]);
  const [colaboradorSelecionado, setColaboradorSelecionado] = useState('');
  const [isAtribuindo, setIsAtribuindo] = useState(false);

  const countries = ['üåç Todos', 'üáßüá∑ Brasil', 'üá∫üá∏ EUA', 'üá¶üá∑ Argentina', 'üá®üá± Chile', 'üáµüá™ Peru', 'üá®üá¥ Col√¥mbia'];

  // Fun√ß√£o para gerar an√°lise IA
  const generateAIAnalysis = async () => {
    try {
      setLoading(true);

      // Simular an√°lise IA baseada nos dados da frota
      const insights = [
        {
          id: 1,
          titulo: "Otimiza√ß√£o de Rotas Detectada",
          descricao: "Baseado nos padr√µes de GPS, 23% dos ve√≠culos podem otimizar suas rotas para economizar combust√≠vel.",
          prioridade: "alta",
          confianca: 87,
          economia_estimada: "2.840",
          risk_score: 3
        },
        {
          id: 2,
          titulo: "Manuten√ß√£o Preventiva Recomendada",
          descricao: `${stats.veiculosAtivos} ve√≠culos est√£o pr√≥ximos do limite de quilometragem para manuten√ß√£o.`,
          prioridade: "media",
          confianca: 74,
          economia_estimada: "1.250",
          risk_score: 6
        },
        {
          id: 3,
          titulo: "Padr√µes de Consumo An√¥malos",
          descricao: "Detectados padr√µes irregulares de consumo em 12% da frota. Poss√≠vel necessidade de calibra√ß√£o.",
          prioridade: "baixa",
          confianca: 92,
          economia_estimada: "890",
          risk_score: 2
        }
      ];

      setAiInsights(insights);
      setAiAnalysisModal(true);
      showSnackbar('An√°lise IA conclu√≠da com sucesso!', 'success');
    } catch (error) {
      console.error('Erro na an√°lise IA:', error);
      showSnackbar('Erro ao gerar an√°lise IA', 'error');
    } finally {
      setLoading(false);
    }
  };

  // Verificar permiss√µes do usu√°rio
  const checkUserPermissions = async (userEmail: string) => {
    try {
      setLoading(true);
      const usuariosRef = collection(db, 'users');
      const q = query(usuariosRef, where('email', '==', userEmail));
      const querySnapshot = await getDocs(q);

      if (!querySnapshot.empty) {
        const userData = querySnapshot.docs[0].data();
        setUserPermissions(userData);

        const role = userData.role?.toLowerCase();
        const canAccessFleet = role === 'superadmin' || role === 'admin' || role === 'gestor' || role === 'colaborador';
        setHasAccess(canAccessFleet);

        if (canAccessFleet) {
          showSnackbar('Acesso autorizado ao sistema de frota!', 'success');
        } else {
          showSnackbar('Acesso negado ao sistema de frota', 'error');
        }
      } else {
        setHasAccess(false);
        showSnackbar('Usu√°rio n√£o encontrado no sistema', 'error');
      }
    } catch (error) {
      console.error('Erro ao verificar permiss√µes:', error);
      setHasAccess(false);
      showSnackbar('Erro ao verificar permiss√µes do usu√°rio', 'error');
    } finally {
      setLoading(false);
    }
  };

  // Carregar dados do Firestore
  const loadVeiculos = async () => {
    if (!user) return;

    try {
      setLoading(true);
      
      // Buscar dados do usu√°rio para obter empresaId
      const userDoc = await getDoc(doc(db, 'users', user.uid));
      const userData = userDoc.exists() ? userDoc.data() : null;
      let empresaId = userData?.empresaId;

      // Se n√£o encontrar empresaId no usu√°rio, buscar empresa onde √© admin
      if (!empresaId) {
        console.log('Buscando empresa do usu√°rio...');
        const empresasSnap = await getDocs(collection(db, 'empresas'));

        for (const empresaDoc of empresasSnap.docs) {
          const empresaData = empresaDoc.data();
          if (empresaData.adminId === user.uid || empresaData.email === user.email) {
            empresaId = empresaDoc.id;
            console.log('Empresa encontrada para carregar ve√≠culos:', empresaId);
            break;
          }
        }
      }

      if (!empresaId) {
        console.log('Empresa n√£o encontrada para carregar ve√≠culos');
        showSnackbar('Empresa n√£o encontrada para carregar ve√≠culos', 'error');
        return;
      }

      // Buscar ve√≠culos na subcole√ß√£o da empresa
      const veiculosRef = collection(db, 'empresas', empresaId, 'veiculos');
      const querySnapshot = await getDocs(veiculosRef);

      const veiculosData: Veiculo[] = [];
      querySnapshot.forEach((doc) => {
        veiculosData.push({ id: doc.id, ...doc.data() } as Veiculo);
      });

      console.log('Ve√≠culos carregados:', veiculosData.length);
      setVeiculos(veiculosData);
      calculateStats(veiculosData);
    } catch (error) {
      console.error('Erro ao carregar ve√≠culos:', error);
      showSnackbar('Erro ao carregar dados da frota', 'error');
    } finally {
      setLoading(false);
    }
  };

  // Calcular estat√≠sticas
  const calculateStats = (veiculosData: Veiculo[]) => {
    const newStats: FleetStats = {
      totalVeiculos: veiculosData.length,
      veiculosAtivos: veiculosData.filter(v => v.status === 'ativo').length,
      multasPendentes: veiculosData.reduce((sum, v) => sum + v.multas, 0),
      motoristasCadastrados: new Set(veiculosData.map(v => v.condutor)).size,
      totalDebitos: veiculosData.reduce((sum, v) => sum + v.valorMultas, 0),
      kmTotalMes: veiculosData.reduce((sum, v) => sum + v.kmRodados, 0),
      consumoTotalCombustivel: veiculosData.reduce((sum, v) => sum + (v.combustivel?.custoMes || 0), 0),
      custosManutencao: veiculosData.length * 450,
    };
    setStats(newStats);
  };

  // Carregar colaboradores dispon√≠veis
  const loadColaboradoresDisponiveis = async () => {
    if (!user) return;

    try {
      // Buscar dados do usu√°rio para obter empresaId
      const userDoc = await getDoc(doc(db, 'users', user.uid));
      const userData = userDoc.exists() ? userDoc.data() : null;
      let empresaId = userData?.empresaId;

      // Se n√£o encontrar empresaId no usu√°rio, buscar empresa onde √© admin
      if (!empresaId) {
        const empresasSnap = await getDocs(collection(db, 'empresas'));

        for (const empresaDoc of empresasSnap.docs) {
          const empresaData = empresaDoc.data();
          if (empresaData.adminId === user.uid || empresaData.email === user.email) {
            empresaId = empresaDoc.id;
            break;
          }
        }
      }

      if (!empresaId) {
        showSnackbar('Empresa n√£o encontrada', 'error');
        return;
      }

      // Buscar colaboradores da empresa
      const colaboradoresSnap = await getDocs(collection(db, 'empresas', empresaId, 'colaboradores'));
      const colaboradoresData = colaboradoresSnap.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));

      setColaboradoresDisponiveis(colaboradoresData);
    } catch (error) {
      console.error('Erro ao carregar colaboradores:', error);
      showSnackbar('Erro ao carregar colaboradores', 'error');
    }
  };

  // Filtrar ve√≠culos
  useEffect(() => {
    if (veiculos.length === 0) {
      setFilteredVeiculos([]);
      return;
    }

    let filtered = [...veiculos];

    if (selectedCountry > 0 && countries[selectedCountry]) {
      const countryName = countries[selectedCountry].split(' ')[1];
      filtered = filtered.filter(v => v.pais === countryName);
    }

    if (statusFilter !== 'todos') {
      filtered = filtered.filter(v => v.status === statusFilter);
    }

    if (searchTerm) {
      const searchLower = searchTerm.toLowerCase();
      filtered = filtered.filter(v => 
        v.placa?.toLowerCase().includes(searchLower) ||
        v.condutor?.toLowerCase().includes(searchLower) ||
        v.modelo?.toLowerCase().includes(searchLower)
      );
    }

    setFilteredVeiculos(filtered);
  }, [veiculos, selectedCountry, statusFilter, searchTerm]);

  // Fun√ß√£o para adicionar colaborador - Mesma l√≥gica do cart√£o ponto
  async function handleAddColaborador() {
    if (!user || !newColaborador.nome || !newColaborador.email || !newColaborador.senha) {
      showSnackbar('Preencha todos os campos obrigat√≥rios!', 'error');
      return;
    }

    try {
      setIsAddingColaborador(true);

      let empresaId: string | null = null;
      let userRole: string = '';

      console.log('Iniciando busca da empresa para o usu√°rio:', user.email);

      // 1. Primeiro tenta buscar no documento do usu√°rio
      const userDoc = await getDoc(doc(db, 'users', user.uid));
      if (userDoc.exists()) {
        const userData = userDoc.data();
        empresaId = userData?.empresaId;
        userRole = userData?.role || '';

        console.log('Dados encontrados no documento do usu√°rio:', {
          empresaId,
          role: userRole,
          email: user.email
        });
      }

      // 2. Se n√£o encontrou empresaId, verifica se o usu√°rio √© dono da empresa (admin)
      if (!empresaId) {
        console.log('EmpresaId n√£o encontrado no documento do usu√°rio. Buscando empresas criadas pelo usu√°rio...');

        const empresasSnap = await getDocs(
          query(
            collection(db, 'empresas'),
            where('adminId', '==', user.uid)
          )
        );

        if (!empresasSnap.empty) {
          const empresaDoc = empresasSnap.docs[0];
          empresaId = empresaDoc.id;
          userRole = 'admin';

          console.log('Empresa encontrada onde usu√°rio √© admin:', {
            empresaId,
            adminId: user.uid,
            email: user.email
          });

          // Cria ou atualiza o documento do usu√°rio com o empresaId encontrado
          await setDoc(doc(db, 'users', user.uid), {
            empresaId: empresaId,
            role: userRole,
            email: user.email,
            displayName: user.displayName || user.email,
            dataCriacao: serverTimestamp(),
            lastLogin: serverTimestamp()
          }, { merge: true });
        }
      }

      // 3. Se ainda n√£o encontrou, busca em todas as empresas por colaborador
      if (!empresaId) {
        console.log('Usu√°rio n√£o √© admin de nenhuma empresa. Buscando como colaborador...');

        const empresasSnap = await getDocs(collection(db, 'empresas'));
        console.log('Total de empresas encontradas:', empresasSnap.docs.length);

        for (const empresaDoc of empresasSnap.docs) {
          console.log('Verificando empresa:', empresaDoc.id);

          // Verifica se o usu√°rio √© admin direto na empresa
          const empresaData = empresaDoc.data();
          if (empresaData.email === user.email || empresaData.adminId === user.uid) {
            empresaId = empresaDoc.id;
            userRole = 'admin';

            console.log('Usu√°rio encontrado como admin da empresa:', {
              empresaId: empresaDoc.id,
              email: user.email
            });

            // Cria ou atualiza o documento do usu√°rio
            await setDoc(doc(db, 'users', user.uid), {
              empresaId: empresaId,
              role: userRole,
              email: user.email,
              displayName: user.displayName || user.email,
              dataCriacao: serverTimestamp(),
              lastLogin: serverTimestamp()
            }, { merge: true });
            break;
          }

          // Se n√£o √© admin, verifica nos colaboradores
          const colaboradoresSnap = await getDocs(
            query(
              collection(db, 'empresas', empresaDoc.id, 'colaboradores'),
              where('email', '==', user.email)
            )
          );

          if (!colaboradoresSnap.empty) {
            const colaboradorData = colaboradoresSnap.docs[0].data();
            userRole = colaboradorData.role;
            empresaId = empresaDoc.id;

            console.log('Colaborador encontrado na empresa:', {
              empresaId: empresaDoc.id,
              role: userRole,
              email: user.email
            });

            // Cria ou atualiza o documento do usu√°rio com o empresaId encontrado
            await setDoc(doc(db, 'users', user.uid), {
              empresaId: empresaId,
              role: userRole,
              email: user.email,
              displayName: user.displayName || user.email,
              dataCriacao: serverTimestamp(),
              lastLogin: serverTimestamp()
            }, { merge: true });

            console.log('Documento do usu√°rio atualizado com empresaId:', empresaId);
            break;
          }
        }
      }

      // 4. Se o usu√°rio tem role superadmin, permite criar colaborador para qualquer empresa
      if (!empresaId && (userRole === 'superadmin' || userPermissions?.role === 'superadmin')) {
        // Para superadmin, vamos usar a primeira empresa dispon√≠vel ou permitir selecionar
        const empresasSnap = await getDocs(collection(db, 'empresas'));
        if (!empresasSnap.empty) {
          empresaId = empresasSnap.docs[0].id;
          console.log('SuperAdmin usando primeira empresa dispon√≠vel:', empresaId);
        }
      }

      // 5. Valida√ß√£o final se encontrou uma empresa
      if (!empresaId) {
        console.error('Nenhuma empresa encontrada para o usu√°rio:', user.email);

        // Mensagem mais detalhada para diferentes cen√°rios
        if (userRole === 'colaborador') {
          showSnackbar('Voc√™ n√£o tem permiss√£o para adicionar colaboradores. Apenas administradores podem adicionar novos colaboradores.', 'error');
        } else {
          showSnackbar('N√£o foi poss√≠vel identificar sua empresa. Verifique suas permiss√µes ou entre em contato com o suporte.', 'error');
        }
        return;
      }

      // 4. Verifica√ß√£o de permiss√£o para adicionar colaboradores
      const rolesPermitidos = ['superadmin', 'admin', 'gestor'];
      const hasPermission = rolesPermitidos.includes(userRole) || rolesPermitidos.includes(userPermissions?.role || '');

      if (!hasPermission) {
        console.error('Usu√°rio sem permiss√£o:', {
          userRole,
          userPermissionsRole: userPermissions?.role,
          email: user.email
        });
        showSnackbar('Voc√™ n√£o tem permiss√£o para adicionar colaboradores', 'error');
        return;
      }

      console.log('Criando colaborador para empresa:', empresaId, 'com permiss√µes v√°lidas');

      // 5. Criar conta no Firebase Auth
      const userCredential = await createUserWithEmailAndPassword(
        auth, 
        newColaborador.email, 
        newColaborador.senha
      );

      // 6. Atualizar perfil do usu√°rio com o nome
      await updateProfile(userCredential.user, {
        displayName: newColaborador.nome
      });

      // 7. Criar documento principal do colaborador (igual ao cart√£o ponto)
      await setDoc(doc(db, 'users', userCredential.user.uid), {
        email: newColaborador.email,
        displayName: newColaborador.nome,
        role: 'colaborador',
        tipo: 'colaborador',
        empresaId: empresaId, // Vincula √† empresa automaticamente
        ativo: true,
        isPessoal: false,
        hourlyRate: 0,
        monthlySalary: 0,
        monthlyBaseHours: 220,
        toleranceMinutes: 0,
        lunchBreakMinutes: 0,
        lunchThresholdMinutes: 360,
        permissions: {
          frota: true,
          ponto: true,
          chamados: true,
          documentos: true
        },
        dataCriacao: serverTimestamp(),
        lastLogin: serverTimestamp()
      });

      // 8. Criar documento do colaborador na empresa (igual ao cart√£o ponto)
      await setDoc(doc(db, 'empresas', empresaId, 'colaboradores', userCredential.user.uid), {
        email: newColaborador.email,
        displayName: newColaborador.nome,
        role: 'colaborador',
        effectiveHourlyRate: 0,
        monthlySalary: 0,
        workDaysPerMonth: 22,
        salaryType: 'monthly',
        hourlyRate: 0,
        dailyRate: 0,
        monthlyRate: 0,
        monthlyBaseHours: 220,
        toleranceMinutes: 0,
        lunchBreakMinutes: 0,
        lunchThresholdMinutes: 360,
        ativo: true,
        isAuthUser: true, // Indica que tem conta Auth
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      });

      console.log('Colaborador criado com sucesso! EmpresaId:', empresaId);
      showSnackbar(`Colaborador adicionado com sucesso! Vinculado √† empresa ${empresaId}`, 'success');
      setNewColaborador({ nome: '', email: '', senha: '' });
      setShowAddColaboradorModal(false);

    } catch (error: any) {
      console.error('Erro detalhado ao adicionar colaborador:', {
        error: error.message,
        code: error.code,
        userEmail: user.email,
        stack: error.stack
      });

      // Tratamento de erros espec√≠ficos
      if (error.code === 'auth/email-already-in-use') {
        showSnackbar('Este email j√° est√° sendo usado por outro usu√°rio', 'error');
      } else if (error.code === 'auth/weak-password') {
        showSnackbar('A senha deve ter pelo menos 6 caracteres', 'error');
      } else if (error.code === 'auth/invalid-email') {
        showSnackbar('Email inv√°lido', 'error');
      } else if (error.message?.includes('permission-denied')) {
        showSnackbar('Erro de permiss√£o. Verifique suas credenciais.', 'error');
      } else {
        showSnackbar(`Erro ao adicionar colaborador: ${error.message}`, 'error');
      }
    } finally {
      setIsAddingColaborador(false);
    }
  }

  // Fun√ß√£o para atribuir colaborador ao ve√≠culo
  const handleAtribuirColaborador = async () => {
    if (!veiculoParaAtribuir || !colaboradorSelecionado || !user) {
      showSnackbar('Selecione um colaborador', 'error');
      return;
    }

    setIsAtribuindo(true);

    try {
      // Buscar dados do usu√°rio para obter empresaId
      const userDoc = await getDoc(doc(db, 'users', user.uid));
      const userData = userDoc.exists() ? userDoc.data() : null;
      let empresaId = userData?.empresaId;

      // Se n√£o encontrar empresaId no usu√°rio, buscar empresa onde √© admin
      if (!empresaId) {
        const empresasSnap = await getDocs(collection(db, 'empresas'));

        for (const empresaDoc of empresasSnap.docs) {
          const empresaData = empresaDoc.data();
          if (empresaData.adminId === user.uid || empresaData.email === user.email) {
            empresaId = empresaDoc.id;
            break;
          }
        }
      }

      if (!empresaId) {
        showSnackbar('Empresa n√£o encontrada', 'error');
        return;
      }

      // Buscar dados do colaborador selecionado
      const colaboradorDoc = await getDoc(doc(db, 'empresas', empresaId, 'colaboradores', colaboradorSelecionado));
      if (!colaboradorDoc.exists()) {
        showSnackbar('Colaborador n√£o encontrado', 'error');
        return;
      }

      const colaboradorData = colaboradorDoc.data();

      // Atualizar o ve√≠culo com o novo condutor
      await updateDoc(doc(db, 'empresas', empresaId, 'veiculos', veiculoParaAtribuir.id), {
        condutor: colaboradorData.email,
        condutorNome: colaboradorData.displayName || colaboradorData.email,
        condutorId: colaboradorSelecionado,
        dataAtribuicao: serverTimestamp(),
        ultimaAtualizacao: serverTimestamp()
      });

      // Registrar no hist√≥rico
      await addDoc(collection(db, 'empresas', empresaId, 'atribuicoes'), {
        veiculoId: veiculoParaAtribuir.id,
        veiculoPlaca: veiculoParaAtribuir.placa,
        colaboradorId: colaboradorSelecionado,
        colaboradorEmail: colaboradorData.email,
        colaboradorNome: colaboradorData.displayName || colaboradorData.email,
        adminId: user.uid,
        adminEmail: user.email,
        tipo: 'atribuicao',
        timestamp: serverTimestamp()
      });

      showSnackbar(`Ve√≠culo ${veiculoParaAtribuir.placa} atribu√≠do a ${colaboradorData.displayName || colaboradorData.email}!`, 'success');
      
      // Fechar modal e limpar estados
      setShowAtribuirModal(false);
      setVeiculoParaAtribuir(null);
      setColaboradorSelecionado('');
      
      // Recarregar lista de ve√≠culos
      await loadVeiculos();

    } catch (error) {
      console.error('Erro ao atribuir colaborador:', error);
      showSnackbar('Erro ao atribuir colaborador ao ve√≠culo', 'error');
    } finally {
      setIsAtribuindo(false);
    }
  };

  // Fun√ß√£o para adicionar ve√≠culo
  async function handleAddVehicle() {
    if (!user || !newVehicleData.marca || !newVehicleData.modelo || !newVehicleData.placa) {
      alert('Preencha todos os campos obrigat√≥rios!');
      return;
    }

    setIsAddingVehicle(true);

    try {
      // Buscar dados do usu√°rio primeiro
      const userDoc = await getDoc(doc(db, 'users', user.uid));
      const userData = userDoc.exists() ? userDoc.data() : null;
      let empresaId = userData?.empresaId;

      // Se n√£o encontrar empresaId no usu√°rio, buscar empresa onde √© admin
      if (!empresaId) {
        console.log('EmpresaId n√£o encontrado no usu√°rio, buscando empresas...');
        const empresasSnap = await getDocs(collection(db, 'empresas'));

        for (const empresaDoc of empresasSnap.docs) {
          const empresaData = empresaDoc.data();
          if (empresaData.adminId === user.uid || empresaData.email === user.email) {
            empresaId = empresaDoc.id;
            console.log('Empresa encontrada:', empresaId);
            break;
          }
        }
      }

      if (!empresaId) {
        alert('Empresa n√£o encontrada. Verifique suas permiss√µes.');
        return;
      }

      // Criar objeto do ve√≠culo com dados padr√£o
      const vehicleData = {
        marca: newVehicleData.marca,
        modelo: newVehicleData.modelo,
        placa: newVehicleData.placa.toUpperCase(),
        ano: parseInt(newVehicleData.ano) || new Date().getFullYear(),
        cor: newVehicleData.cor,
        renavam: '',
        adminId: user.uid,
        empresaId: empresaId,
        ativo: true,
        status: 'ativo' as const,
        condutor: '',
        pais: 'Brasil',
        cidade: 'S√£o Paulo',
        multas: 0,
        valorMultas: 0,
        vencimentoIPVA: '',
        vencimentoLicenciamento: '',
        kmRodados: 0,
        consumoMedio: 0,
        ultimaManutencao: '',
        proximaManutencao: '',
        seguro: {
          vencimento: '',
          valor: 0,
          seguradora: ''
        },
        gps: {
          latitude: -23.5505,
          longitude: -46.6333,
          ultimaAtualizacao: new Date().toISOString()
        },
        combustivel: {
          nivel: 100,
          tipo: 'Gasolina',
          custoMes: 0
        },
        dataCriacao: serverTimestamp(),
        dataAtualizacao: serverTimestamp()
      };

      console.log('Adicionando ve√≠culo:', vehicleData);
      const docRef = await addDoc(collection(db, 'empresas', empresaId, 'veiculos'), vehicleData);
      console.log('Ve√≠culo adicionado com ID:', docRef.id);

      showSnackbar('Ve√≠culo adicionado com sucesso!', 'success');
      setNewVehicleData({ marca: '', modelo: '', placa: '', ano: '', cor: '' });
      setShowAddVehicleModal(false);
      
      // Recarregar lista de ve√≠culos
      await loadVeiculos();

    } catch (error) {
      console.error('Erro ao adicionar ve√≠culo:', error);
      alert('Erro ao adicionar ve√≠culo: ' + error.message);
    } finally {
      setIsAddingVehicle(false);
    }
  }

  const showSnackbar = (message: string, type: 'success' | 'error') => {
    setSnackbar({ open: true, message, type });
  };

  const getStatusColor = (status: string) => {
    switch (status) {
      case 'ativo': return '#00ff7f';
      case 'manutencao': return '#ffd700';
      case 'inativo': return '#ff6b6b';
      case 'em_viagem': return '#1e90ff';
      default: return '#666';
    }
  };

  // Verificar autentica√ß√£o e obter dados do usu√°rio
  useEffect(() => {
    const unsubscribe = onAuthStateChanged(auth, async (currentUser) => {
      if (!currentUser) {
        router.push('/frota/auth');
        return;
      }

      setUser(currentUser);

      // Verificar papel do usu√°rio primeiro
      try {
        const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
        if (userDoc.exists()) {
          const userData = userDoc.data();
          const userRole = userData.role?.toLowerCase();

          // Se for colaborador, redirecionar para √°rea espec√≠fica
          if (userRole === 'colaborador') {
            router.push('/frota/colaborador');
            return;
          }
        }
      } catch (error) {
        console.error('Erro ao verificar papel do usu√°rio:', error);
      }

      // Carregar dados do usu√°rio e empresa para admins/gestores
      await checkUserPermissions(currentUser.email!);
    });

    return () => unsubscribe();
  }, [router]); // Added router to dependency array

  useEffect(() => {
    if (hasAccess && user) {
      loadVeiculos();
    } else if (!hasAccess && user && !loading) {
    } else if (!user && !loading) {
    }
    if (hasAccess || (!hasAccess && user)) {
      setLoading(false);
    }
  }, [hasAccess, user, loading]);


  if (!hasAccess && !loading) {
    return (
      <div className="container">
        <style jsx>{`
          .access-denied {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: var(--color-background);
          }
          .access-card {
            text-align: center;
            background: var(--color-surface);
            padding: 3rem;
            border-radius: var(--radius-lg);
            border: 1px solid var(--color-border);
            max-width: 500px;
          }
        `}</style>

        <div className="access-denied">
          <div className="access-card">
            <div style={{ fontSize: '4rem', marginBottom: '1rem' }}>üö´</div>
            <h1>Acesso Restrito</h1>
            <p style={{ marginBottom: '2rem' }}>
              Voc√™ n√£o tem permiss√£o para acessar o sistema de frota.
            </p>
            <div style={{ display: 'flex', gap: '1rem', justifyContent: 'center' }}>
              <Link href="/frota/auth" className="button button-primary">
                Fazer Login
              </Link>
              <Link href="/sistemas" className="button button-outline">
                Voltar aos Sistemas
              </Link>
            </div>
          </div>
        </div>
      </div>
    );
  }

  if (loading) {
    return (
      <div className="container">
        <style jsx>{`
          .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: var(--color-background);
          }
        `}</