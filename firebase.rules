
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Função para verificar se é super admin
    function isSuperAdmin() {
      return request.auth != null && (
        request.auth.token.bootstrapAdmin == true ||
        request.auth.token.role == 'superadmin' ||
        request.auth.token.role == 'adminmaster' ||
        request.auth.uid in ['BOOTSTRAP_ADMIN_UID'] // Substitua pelo UID real se necessário
      );
    }

    // Função para verificar se é admin
    function isAdmin() {
      return request.auth != null && (
        isSuperAdmin() ||
        request.auth.token.role == 'admin' ||
        request.auth.token.role == 'gestor'
      );
    }

    // Função para verificar se o usuário está autenticado
    function isAuthenticated() {
      return request.auth != null;
    }

    // === REGRAS PARA SUPER ADMINS ===
    // Super admins têm acesso total a tudo
    match /{document=**} {
      allow read, write: if isSuperAdmin();
    }

    // === COLEÇÕES ADMINISTRATIVAS ===
    // Usuários - acesso completo para admins
    match /users/{userId} {
      allow read, write: if isAdmin();
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    // Bootstrap admins - apenas para super admins
    match /bootstrap_admins/{userId} {
      allow read, write: if isSuperAdmin();
    }

    // === COLEÇÕES DE EMPRESAS ===
    match /empresas/{empresaId} {
      allow read, write: if isAdmin();
      allow read: if isAuthenticated();
    }

    match /companies/{companyId} {
      allow read, write: if isAdmin();
      allow read: if isAuthenticated();
    }

    match /chamados_empresas/{empresaId} {
      allow read, write: if isAdmin();
      allow read: if isAuthenticated();
    }

    match /financeiro_empresas/{empresaId} {
      allow read, write: if isAdmin();
      allow read: if isAuthenticated();
    }

    match /documentos_empresas/{empresaId} {
      allow read, write: if isAdmin();
      allow read: if isAuthenticated();
    }

    // === COLEÇÕES DE SISTEMA ===
    match /system_settings/{document} {
      allow read, write: if isAdmin();
    }

    match /system_logs/{document} {
      allow read, write: if isAdmin();
    }

    match /system_reports/{document} {
      allow read, write: if isAdmin();
    }

    match /admin_actions/{document} {
      allow read, write: if isAdmin();
    }

    match /admin_notifications/{document} {
      allow read, write: if isAdmin();
    }

    // === COLEÇÕES DE MONITORAMENTO ===
    match /security_alerts/{document} {
      allow read, write: if isAdmin();
    }

    match /system_alerts/{document} {
      allow read, write: if isAdmin();
    }

    match /business_alerts/{document} {
      allow read, write: if isAdmin();
    }

    match /security_events/{document} {
      allow read, write: if isAdmin();
    }

    match /audit_logs/{document} {
      allow read, write: if isAdmin();
    }

    // === COLEÇÕES DE SISTEMA DE CHAMADOS ===
    match /chamados/{document} {
      allow read, write: if isAuthenticated();
    }

    match /chamados_users/{document} {
      allow read, write: if isAuthenticated();
    }

    // === COLEÇÕES DE SISTEMA FINANCEIRO ===
    match /financeiro_users/{document} {
      allow read, write: if isAuthenticated();
    }

    match /documentos_fiscais/{document} {
      allow read, write: if isAuthenticated();
    }

    // === COLEÇÕES DE SISTEMA DE FROTA ===
    match /frota_users/{document} {
      allow read, write: if isAuthenticated();
    }

    match /veiculos/{document} {
      allow read, write: if isAuthenticated();
    }

    // === COLEÇÕES DE SISTEMA DE DOCUMENTOS ===
    match /documentos_users/{document} {
      allow read, write: if isAuthenticated();
    }

    match /templates/{document} {
      allow read, write: if isAuthenticated();
    }

    // === COLEÇÕES DE SESSÕES E PONTOS ===
    match /users/{userId}/sessions/{sessionId} {
      allow read, write: if isAdmin();
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    // === COLEÇÕES DE TUTORIAL ===
    match /userTutorialStatus/{userId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
      allow read, write: if isAdmin();
    }

    // === REGRA PADRÃO PARA OUTRAS COLEÇÕES ===
    // Permitir leitura para usuários autenticados, escrita para admins
    match /{collection}/{document} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // === SUBCOLEÇÕES ===
    match /{path=**}/{subcollection}/{document} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
  }
}
