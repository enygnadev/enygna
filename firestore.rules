rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ===== FUNÇÕES DE SEGURANÇA =====
    function isSuperAdmin() {
      return request.auth != null && request.auth.token != null && (
        (request.auth.token.bootstrapAdmin == true) ||
        (request.auth.token.role == 'superadmin') ||
        (request.auth.token.role == 'adminmaster')
      );
    }
    function isAdmin() {
      return request.auth != null && request.auth.token != null && (
        isSuperAdmin() || request.auth.token.role == 'admin' || request.auth.token.role == 'gestor'
      );
    }
    function isEmpresa() {
      return request.auth != null && request.auth.token != null && (
        request.auth.token.tipo == 'empresa' || request.auth.token.role == 'empresa' || request.auth.token.isEmpresa == true
      );
    }
    function isAuthenticated() { return request.auth != null && request.auth.uid != null; }
    function isCompanyOwnerOrAuthorized(empresaId) {
      return request.auth != null && (
        request.auth.token.empresaId == empresaId || request.auth.token.company == empresaId || request.auth.uid == empresaId ||
        (exists(/databases/$(database)/documents/empresas/$(empresaId)) && get(/databases/$(database)/documents/empresas/$(empresaId)).data.email == request.auth.token.email)
      );
    }
    function isCompanyCollaborator(empresaId) {
      return request.auth != null && (
        isCompanyOwnerOrAuthorized(empresaId) || exists(/databases/$(database)/documents/empresas/$(empresaId)/colaboradores/$(request.auth.uid))
      );
    }
    function hasRequiredFields(requiredFields) {
      return request.resource.data.keys().hasAll(requiredFields);
    }
    function hasUserSystemAccess(sistema) {
      return request.auth != null && request.auth.token != null && (
        isSuperAdmin() || isAdmin() ||
        (request.auth.token.sistemasAtivos != null && request.auth.token.sistemasAtivos.hasAny([sistema])) ||
        (request.auth.token.canAccessSystems != null && request.auth.token.canAccessSystems.hasAny([sistema]))
      );
    }

    // ===== SUPERADMINS - ACESSO TOTAL =====
    match /{document=**} { allow read, write: if isSuperAdmin(); }

    // ===== USUÁRIOS =====
    match /users/{userId} {
      allow read, write: if isSuperAdmin();
      allow read, update: if isAuthenticated() && request.auth.uid == userId;
      allow read: if isAdmin() && resource.data.role != 'superadmin';
      allow create: if isAuthenticated() && request.resource.data.keys().hasAll(['email']);
    }

    // ===== EMPRESAS - PERMITIR CRIAÇÃO =====
    match /empresas/{empresaId} {
      allow read, write: if isSuperAdmin();
      allow read, update: if isAuthenticated() && isCompanyOwnerOrAuthorized(empresaId);
      // CORREÇÃO: Permitir criação de empresas por usuários autenticados
      allow create: if isAuthenticated() && hasRequiredFields(['nome', 'email']);

      match /{subcollection}/{document} {
        allow read, write: if isSuperAdmin();
        allow read, write, create: if isAuthenticated() && isCompanyOwnerOrAuthorized(empresaId);
      }

      match /colaboradores/{colaboradorId} {
        allow read, write: if isSuperAdmin();
        allow read, write, create: if isAuthenticated() && isCompanyOwnerOrAuthorized(empresaId);
        allow read, update: if isAuthenticated() && request.auth.uid == colaboradorId;

        match /sessions/{sessionId} {
          allow read, write, create: if isSuperAdmin();
          allow read, write, create: if isAuthenticated() && (isCompanyOwnerOrAuthorized(empresaId) || request.auth.uid == colaboradorId);
        }
      }
    }

    // ===== ALIASES PARA EMPRESAS =====
    match /companies/{companyId} {
      allow read, write: if isSuperAdmin();
      allow read, update: if isAuthenticated() && isCompanyOwnerOrAuthorized(companyId);
      allow create: if isAuthenticated() && hasRequiredFields(['nome', 'email']);
      match /{subcollection}/{document} {
        allow read, write, create: if isSuperAdmin();
        allow read, write, create: if isAuthenticated() && isCompanyOwnerOrAuthorized(companyId);
      }
    }

    // ===== SISTEMAS ESPECÍFICOS =====
    match /chamados_empresas/{empresaId} {
      allow read, write: if isSuperAdmin();
      allow read, write, create: if isAuthenticated() && isCompanyCollaborator(empresaId) && hasUserSystemAccess('chamados');
      match /{subcollection}/{document} {
        allow read, write, create: if isSuperAdmin();
        allow read, write, create: if isAuthenticated() && isCompanyCollaborator(empresaId);
      }
    }
    match /chamados/{document} {
      allow read, write, create: if isSuperAdmin();
      allow read, update: if isAuthenticated() && (resource.data.userId == request.auth.uid || isAdmin() || hasUserSystemAccess('chamados'));
      allow create: if isAuthenticated() && hasUserSystemAccess('chamados') && hasRequiredFields(['titulo', 'descricao']);
    }
    match /financeiro_empresas/{empresaId} {
      allow read, write: if isSuperAdmin();
      allow read, write, create: if isAuthenticated() && isCompanyOwnerOrAuthorized(empresaId) && hasUserSystemAccess('financeiro');
      match /{subcollection}/{document} {
        allow read, write, create: if isSuperAdmin();
        allow read, write, create: if isAuthenticated() && isCompanyOwnerOrAuthorized(empresaId);
      }
    }
    match /frota_empresas/{empresaId} {
      allow read, write: if isSuperAdmin();
      allow read, write, create: if isAuthenticated() && isCompanyOwnerOrAuthorized(empresaId) && hasUserSystemAccess('frota');
      match /{subcollection}/{document} {
        allow read, write, create: if isSuperAdmin();
        allow read, write, create: if isAuthenticated() && isCompanyOwnerOrAuthorized(empresaId);
      }
    }
    match /documentos_empresas/{empresaId} {
      allow read, write: if isSuperAdmin();
      allow read, write, create: if isAuthenticated() && isCompanyOwnerOrAuthorized(empresaId) && hasUserSystemAccess('documentos');
      match /{subcollection}/{document} {
        allow read, write, create: if isSuperAdmin();
        allow read, write, create: if isAuthenticated() && isCompanyOwnerOrAuthorized(empresaId);
      }
    }
    match /ponto_empresas/{empresaId} {
      allow read, write: if isSuperAdmin();
      allow read: if isAuthenticated() && isCompanyCollaborator(empresaId);
      allow write, create: if isAuthenticated() && isCompanyOwnerOrAuthorized(empresaId) && hasUserSystemAccess('ponto');
      match /{subcollection}/{document} {
        allow read, write, create: if isSuperAdmin();
        allow read, write, create: if isAuthenticated() && isCompanyCollaborator(empresaId);
      }
    }
    match /crm_empresas/{empresaId} {
      allow read, write: if isSuperAdmin();
      allow read: if isAuthenticated() && isCompanyCollaborator(empresaId);
      allow write, create: if isAuthenticated() && isCompanyOwnerOrAuthorized(empresaId) && hasUserSystemAccess('crm');
      match /{subcollection}/{document} {
        allow read, write, create: if isSuperAdmin();
        allow read, write, create: if isAuthenticated() && isCompanyOwnerOrAuthorized(empresaId);
      }
    }

    // ===== SESSÕES E DADOS PESSOAIS =====
    match /users/{userId}/sessions/{sessionId} {
      allow read, write, create: if isAuthenticated() && request.auth.uid == userId;
      allow read: if isSuperAdmin();
    }
    match /sessions/{document} {
      allow read, write: if isSuperAdmin();
      allow read, update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid && hasRequiredFields(['userId', 'empresaId', 'timestamp']);
    }
    match /userTutorialStatus/{userId} {
      allow read, write, create: if isAuthenticated() && request.auth.uid == userId;
      allow read: if isSuperAdmin();
    }

    // ===== CONFIGURAÇÕES PÚBLICAS =====
    match /planos/{document} {
      allow read: if true;
      allow write: if isSuperAdmin();
    }
    match /app_config/{document} {
      allow read: if true;
      allow write: if isSuperAdmin();
    }
    match /system_settings/{document} {
      allow read, write: if isSuperAdmin();
      allow read: if isAdmin();
      allow read: if isAuthenticated() && isEmpresa();
    }

    // ===== LOGS E AUDITORIA =====
    match /system_logs/{document} { allow read, write: if isSuperAdmin(); }
    match /security_events/{document} {
      allow read, write: if isSuperAdmin();
      allow create: if isAuthenticated();
    }
    match /audit_logs/{document} {
      allow read, write: if isSuperAdmin();
      allow read: if isAdmin();
      allow create: if isAuthenticated();
    }

    // ===== NOTIFICAÇÕES =====
    match /admin_notifications/{document} {
      allow read, write: if isSuperAdmin();
      allow read: if isAdmin();
      allow read: if isAuthenticated() && isEmpresa();
    }

    // ===== MONITORAMENTO =====
    match /performance_metrics/{document} {
      allow read, write: if isSuperAdmin();
      allow read: if isAdmin();
      allow create: if isAuthenticated();
    }
    match /health_checks/{document} {
      allow read, write: if isSuperAdmin();
      allow read: if isAdmin();
    }
    match /error_reports/{document} {
      allow read, write: if isSuperAdmin();
      allow read: if isAdmin();
      allow create: if isAuthenticated();
    }

    // ===== CACHE =====
    match /cache/{document} {
      allow read, write: if isSuperAdmin();
      allow read: if isAuthenticated();
    }

    // ===== DENY EXPLÍCITAS =====
    match /internal_logs/{document} { allow read, write: if false; }
    match /system_secrets/{document} { allow read, write: if false; }
    match /backup_data/{document} { allow read, write: if isSuperAdmin(); }
    match /bootstrap_admins/{userId} { allow read, write: if isSuperAdmin(); }

    // ===== REGRAS PADRÃO =====
    match /{collection}/{document} {
      allow read: if isAuthenticated() && (collection in ['help_docs', 'faq', 'announcements', 'system_info']);
      allow create: if isAuthenticated() && (collection in ['feedback', 'support_requests']) && hasRequiredFields(['userId', 'timestamp']);
      allow read: if isAuthenticated() && isEmpresa() && collection in ['system_info', 'help_docs', 'announcements'];
    }
    match /{path=**}/{subcollection}/{document} {
      allow read, write: if isSuperAdmin();
      allow read: if isAuthenticated() && isEmpresa();
    }
  }
}