rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ===== FUNÇÕES DE SEGURANÇA =====
    function isSuperAdmin() {
      return request.auth != null && request.auth.token != null && (
        (request.auth.token.bootstrapAdmin == true) ||
        (request.auth.token.role == 'superadmin') ||
        (request.auth.token.role == 'adminmaster') ||
        (
          exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.bootstrapAdmin == true
        ) ||
        (
          exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'superadmin'
        ) ||
        (
          exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'adminmaster'
        )
      );
    }

    function isAdmin() {
      return request.auth != null && request.auth.token != null && (
        isSuperAdmin() || 
        request.auth.token.role == 'admin' || 
        request.auth.token.role == 'gestor'
      );
    }



    function isAuthenticated() { 
      return request.auth != null && request.auth.uid != null; 
    }

    function isCompanyOwnerOrAuthorized(empresaId) {
      return isAuthenticated() && (
        request.auth.token.empresaId == empresaId ||
        request.auth.token.company == empresaId ||
        (
          exists(/databases/$(database)/documents/empresas/$(empresaId)) &&
          get(/databases/$(database)/documents/empresas/$(empresaId)).data.ownerUid == request.auth.uid
        ) ||
        (
          exists(/databases/$(database)/documents/empresas/$(empresaId)) &&
          get(/databases/$(database)/documents/empresas/$(empresaId)).data.email == request.auth.token.email
        )
      );
    }

    function isCompanyCollaborator(empresaId) {
      return request.auth != null && (
        isCompanyOwnerOrAuthorized(empresaId) || 
        exists(/databases/$(database)/documents/empresas/$(empresaId)/colaboradores/$(request.auth.uid))
      );
    }

    function hasRequiredFields(requiredFields) {
      return request.resource.data.keys().hasAll(requiredFields);
    }





    function sameCompany(empresaId) {
      return request.auth != null && request.auth.token != null && (
        request.auth.token.empresaId == empresaId || 
        request.auth.token.company == empresaId ||
        isEmpresaUser() ||
        // Verificar se o email do usuário corresponde ao email da empresa
        (resource != null && resource.data != null && resource.data.empresaId == empresaId) ||
        // Para novos documentos, verificar se o empresaId está sendo definido corretamente
        (request.resource != null && request.resource.data != null && request.resource.data.empresaId == empresaId)
      );
    }

    function hasRole(roles) {
      return request.auth != null && request.auth.token != null && roles.hasAny([request.auth.token.role]);
    }

    function isEmpresaUser() {
      return request.auth != null && request.auth.token != null && (
        request.auth.token.role == 'empresa' ||
        request.auth.token.role == 'admin' ||
        request.auth.token.role == 'gestor' ||
        (
          exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
          (
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'empresa' ||
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tipo == 'empresa'
          )
        )
      );
    }

    // ----- Funções auxiliares para sistemas unificados -----
    function hasSystemAccess(systemName) {
      return request.auth != null && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.sistemasAtivos.hasAny([systemName]);
    }

    function belongsToUserCompany(resourceCompanyId) {
      return request.auth != null && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.empresaId == resourceCompanyId;
    }

    function canAccessTicketSystem() {
      return hasSystemAccess('chamados');
    }

    // ===== SUPERADMINS - ACESSO TOTAL =====
    match /{document=**} { 
      allow read, write: if isSuperAdmin(); 
    }

    // ===== ACESSO ESPECÍFICO PARA ADMINS DO SISTEMA =====
    match /admin_access/{document} {
      allow read, write: if isAuthenticated() && (
        request.auth.token.bootstrapAdmin == true ||
        isSuperAdmin()
      );
    }

    // ===== COLEÇÃO DE USUÁRIOS =====
    match /users/{userId} {
      allow read: if isAuthenticated() && (
        isSuperAdmin() || isAdmin() || isEmpresaUser() ||
        request.auth.uid == userId ||
        sameCompany(resource.data.empresaId)
      );

      allow update: if isAuthenticated() && (
        isSuperAdmin() || isAdmin() || isEmpresaUser() ||
        request.auth.uid == userId
      );

      allow create: if isAuthenticated() && (
        isSuperAdmin() || isAdmin() || isEmpresaUser() ||
        // Empresa pode criar usuários para sua empresa
        (request.resource.data.empresaId != null && sameCompany(request.resource.data.empresaId))
      );

      allow delete: if isAuthenticated() && (
        isSuperAdmin() || isAdmin()
      );
    }

    // ===== EMPRESAS - CRIAÇÃO SEGURA E DONO EXPLÍCITO =====
    match /empresas/{empresaId} {
      allow read, write: if isSuperAdmin();

      // Leitura para usuários autenticados (necessário para verificar sistemas)
      allow read: if isAuthenticated();

      allow read, update: if isAuthenticated() && isCompanyOwnerOrAuthorized(empresaId);

      // Criação segura - mais permissiva para resolver o problema atual
      allow create: if isAuthenticated() && (
        hasRequiredFields(['nome','email']) &&
        request.resource.data.nome.size() > 0 &&
        request.resource.data.nome.size() <= 100 ||
        isAdmin()
      );

      match /{subcollection}/{document} {
        allow read, write: if isSuperAdmin();
        allow read, write, create: if isAuthenticated() && isCompanyOwnerOrAuthorized(empresaId);
      }

      match /colaboradores/{colaboradorId} {
        allow read, write: if isSuperAdmin();
        allow read, write, create: if isAuthenticated() && isCompanyOwnerOrAuthorized(empresaId);
        allow read, update: if isAuthenticated() && request.auth.uid == colaboradorId;

        match /sessions/{sessionId} {
          allow read, write, create: if isSuperAdmin();
          allow read, write, create: if isAuthenticated() && (
            isCompanyOwnerOrAuthorized(empresaId) || 
            request.auth.uid == colaboradorId
          );
        }
      }
    }

    // ===== SISTEMAS ESPECÍFICOS COM EMPRESAID AMARRADO =====
    match /chamados_empresas/{empresaId} {
      allow read, write: if isSuperAdmin();
      allow read: if isAuthenticated() && isCompanyCollaborator(empresaId);
      allow write, create: if isAuthenticated() && 
        isCompanyCollaborator(empresaId) && 
        request.resource.data.empresaId == empresaId;

      match /{subcollection}/{document} {
        allow read, write, create: if isSuperAdmin();
        allow read, write, create: if isAuthenticated() && isCompanyCollaborator(empresaId);
      }
    }

    match /financeiro_empresas/{empresaId} {
      allow read, write: if isSuperAdmin();
      allow read: if isAuthenticated() && sameCompany(empresaId);
      allow write, create: if isAuthenticated() && 
        sameCompany(empresaId) && 
        request.resource.data.empresaId == empresaId;

      match /{subcollection}/{document} {
        allow read, write, create: if isSuperAdmin();
        allow read, write, create: if isAuthenticated() && sameCompany(empresaId);
      }
    }

    match /frota_empresas/{empresaId} {
      allow read, write: if isSuperAdmin();
      allow read: if isAuthenticated() && sameCompany(empresaId);
      allow write, create: if isAuthenticated() && 
        sameCompany(empresaId) &&
        request.resource.data.empresaId == empresaId;

      match /{subcollection}/{document} {
        allow read, write, create: if isSuperAdmin();
        allow read, write, create: if isAuthenticated() && sameCompany(empresaId);
      }
    }

    match /documentos_empresas/{empresaId} {
      allow read, write: if isSuperAdmin();

      // Empresa pode ler seus próprios dados
      allow read: if isAuthenticated() && (
        sameCompany(empresaId) || 
        isEmpresaUser() ||
        request.auth.token.empresaId == empresaId ||
        request.auth.token.company == empresaId
      );

      // Empresa pode criar e editar seus próprios dados
      allow write, create, update, delete: if isAuthenticated() && (
        sameCompany(empresaId) || 
        isEmpresaUser() ||
        request.auth.token.empresaId == empresaId ||
        request.auth.token.company == empresaId
      ) && (
        request.resource.data.empresaId == empresaId || 
        request.resource.data.empresaId == request.auth.token.empresaId ||
        request.resource.data.empresaId == request.auth.token.company
      );

      match /{subcollection}/{document} {
        allow read, write, create: if isSuperAdmin();
        allow read, write, create, update, delete: if isAuthenticated() && (
          sameCompany(empresaId) || 
          isEmpresaUser() ||
          request.auth.token.empresaId == empresaId ||
          request.auth.token.company == empresaId
        );
      }
    }

    // ===== DOCUMENTOS - Sistema de Documentos =====
    match /document_templates/{templateId} {
      allow read, write: if isSuperAdmin();

      // Usuários autenticados podem ler templates globais (sem empresaId)
      allow read: if isAuthenticated() && (
        !resource.data.keys().hasAny(['empresaId']) ||
        resource.data.empresaId == null ||
        resource.data.empresaId == ""
      );

      // Usuários podem ler templates da sua empresa
      allow read: if isAuthenticated() && (
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.empresaId == resource.data.empresaId &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.sistemasAtivos.hasAny(['documentos'])
      );

      // Usuários podem criar templates para sua empresa
      allow create: if isAuthenticated() && (
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.empresaId == request.resource.data.empresaId &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.sistemasAtivos.hasAny(['documentos'])
      );
    }

    match /generated_documents/{documentId} {
      allow read, write: if isSuperAdmin();

      // Usuário pode ler seus próprios documentos
      allow read: if isAuthenticated() && resource.data.createdBy == request.auth.uid;

      // Usuário pode ler documentos da sua empresa
      allow read: if isAuthenticated() && (
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.empresaId == resource.data.empresaId &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.sistemasAtivos.hasAny(['documentos'])
      );

      // Usuário pode criar documentos
      allow create: if isAuthenticated() && (
        request.resource.data.createdBy == request.auth.uid &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.sistemasAtivos.hasAny(['documentos']) &&
        (
          !request.resource.data.keys().hasAny(['empresaId']) ||
          request.resource.data.empresaId == "" ||
          request.resource.data.empresaId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.empresaId
        )
      );

      // Usuário pode editar seus próprios documentos
      allow update, delete: if isAuthenticated() && resource.data.createdBy == request.auth.uid;
    }

    match /ponto_empresas/{empresaId} {
      allow read, write: if isSuperAdmin();

      allow read: if isAuthenticated() && isCompanyCollaborator(empresaId);

      allow create: if isAuthenticated() &&
                    sameCompany(empresaId) &&
                    request.resource.data.userId == request.auth.uid &&
                    request.resource.data.empresaId == empresaId;

      allow update: if isAuthenticated() &&
                    sameCompany(empresaId) &&
                    (
                      isAdmin() ||
                      (
                        resource.data.userId == request.auth.uid &&
                        resource.data.timestamp > request.time - duration.value(5, 'm')
                      )
                    ) &&
                    request.resource.data.empresaId == empresaId;

      allow delete: if isAuthenticated() &&
                    sameCompany(empresaId) &&
                    (isAdmin() || request.auth.token.role == 'gestor');

      match /{subcollection}/{document} {
        allow read, write, create: if isSuperAdmin();
        allow read, write, create: if isAuthenticated() && isCompanyCollaborator(empresaId);
      }
    }

    match /crm_empresas/{empresaId} {
      allow read, write: if isSuperAdmin();
      allow read: if isAuthenticated() && isCompanyCollaborator(empresaId);
      allow write, create: if isAuthenticated() && 
        sameCompany(empresaId) && 
        request.resource.data.empresaId == empresaId;

      match /{subcollection}/{document} {
        allow read, write, create: if isSuperAdmin();
        allow read, write, create: if isAuthenticated() && sameCompany(empresaId);
      }
    }

    // ===== NOTIFICAÇÕES - Permissões mais flexíveis =====
    match /Notifications/{userId}/items/{notificationId} {
      allow read, write: if isSuperAdmin();
      allow read, update, delete: if isAuthenticated() && request.auth.uid == userId;
      allow create: if isAuthenticated() &&
                    request.resource.data.userId == userId;
    }

    // Notificações gerais - acesso para usuários autenticados
    match /notifications/{document} {
      allow read: if isAuthenticated();
      allow write: if isSuperAdmin();
      allow create: if isAuthenticated();
    }

    // ===== SESSÕES E DADOS PESSOAIS =====
    match /users/{userId}/sessions/{sessionId} {
      allow read, write, create: if isAuthenticated() && request.auth.uid == userId;
      allow read: if isSuperAdmin();
    }

    match /sessions/{document} {
      allow read, write: if isSuperAdmin();
      allow read, update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
    }

    match /userTutorialStatus/{userId} {
      allow read, write, create: if isAuthenticated() && request.auth.uid == userId;
      allow read: if isSuperAdmin();
    }

    // ===== CONFIGURAÇÕES PÚBLICAS =====
    match /planos/{document} {
      allow read: if true;
      allow write: if isSuperAdmin();
    }

    match /app_config/{document} {
      allow read: if true;
      allow write: if isSuperAdmin();
    }

    match /system_settings/{document} {
      allow read, write: if isSuperAdmin();
      allow read: if isAdmin();
      allow read: if isAuthenticated();
    }

    // ===== LOGS E AUDITORIA - Mais permissivo =====
    match /system_logs/{document} { 
      allow read, write: if isSuperAdmin();
      allow read: if isAdmin();
    }

    match /security_events/{document} {
      allow read, write: if isSuperAdmin();
      allow read: if isAdmin();
      allow create: if isAuthenticated();
    }

    match /audit_logs/{document} {
      allow read, write: if isSuperAdmin();
      allow read: if isAdmin();
      allow create: if isAuthenticated();
    }

    // ===== NOTIFICAÇÕES ADMINISTRATIVAS =====
    match /admin_notifications/{document} {
      allow read, write: if isSuperAdmin();
      allow read: if isAdmin();
      allow read: if isAuthenticated();
    }

    // ===== MONITORAMENTO - Mais permissivo =====
    match /performance_metrics/{document} {
      allow read, write: if isSuperAdmin();
      allow read: if isAdmin();
      allow create: if isAuthenticated();
    }

    match /health_checks/{document} {
      allow read, write: if isSuperAdmin();
      allow read: if isAdmin();
    }

    match /error_reports/{document} {
      allow read, write: if isSuperAdmin();
      allow read: if isAdmin();
      allow create: if isAuthenticated();
    }

    // ===== CACHE =====
    match /cache/{document} {
      allow read, write: if isSuperAdmin();
      allow read: if isAuthenticated();
    }

    // ===== ALERTAS - Mais permissivo =====
    match /system_alerts/{document} {
      allow read, write: if isSuperAdmin();
      allow read: if isAuthenticated();
    }

    match /business_alerts/{document} {
      allow read, write: if isSuperAdmin();
      allow read: if isAuthenticated();
    }

    // ===== DENY EXPLÍCITAS =====
    match /internal_logs/{document} { 
      allow read, write: if false; 
    }

    match /system_secrets/{document} { 
      allow read, write: if false; 
    }

    match /backup_data/{document} { 
      allow read, write: if isSuperAdmin(); 
    }

    match /bootstrap_admins/{userId} { 
      allow read, write: if isSuperAdmin(); 
    }

    // ===== SISTEMA DE TICKETS/CHAMADOS =====
    match /tickets/{ticketId} {
      allow read, write: if isSuperAdmin();

      // Usuários podem ler tickets da sua empresa
      allow read: if isAuthenticated() && (
        isEmpresaUser() ||
        isAdmin() ||
        (canAccessTicketSystem() && belongsToUserCompany(resource.data.empresaId)) ||
        sameCompany(resource.data.empresaId)
      );

      // Usuários podem criar tickets para sua empresa
      allow create: if isAuthenticated() && (
        isEmpresaUser() ||
        isAdmin() ||
        (canAccessTicketSystem() && belongsToUserCompany(request.resource.data.empresaId) && 
         request.resource.data.createdBy == request.auth.uid)
      );

      // Usuários podem editar seus próprios tickets ou admins podem editar todos da empresa
      allow update: if isAuthenticated() && (
        isEmpresaUser() ||
        isAdmin() ||
        (canAccessTicketSystem() && 
         (resource.data.createdBy == request.auth.uid || 
          belongsToUserCompany(resource.data.empresaId)))
      );

      // Apenas admins podem deletar tickets
      allow delete: if isAuthenticated() && (
        isAdmin() ||
        isSuperAdmin()
      );

      // Subcoleções de tickets (comentários, auditoria, etc.)
      match /{subcollection}/{document} {
        allow read, write: if isSuperAdmin();
        allow read, write, create: if isAuthenticated() && (
          isEmpresaUser() ||
          isAdmin() ||
          canAccessTicketSystem()
        );
      }
    }

    // ===== REGRAS PADRÃO =====
    match /{collection}/{document} {
      allow read: if isAuthenticated() && (
        collection in ['help_docs', 'faq', 'announcements', 'system_info']
      );
      allow create: if isAuthenticated() && (
        collection in ['feedback', 'support_requests']
      ) && request.resource.data.userId == request.auth.uid;
      allow read: if isAuthenticated() && 
        collection in ['system_info', 'help_docs', 'announcements'];

      // Permitir acesso aos documentos para empresas autenticadas
      allow read, write, create, update, delete: if isAuthenticated() && 
        collection == 'documentos' && 
        (isEmpresaUser() || hasRole(['superadmin', 'adminmaster', 'admin', 'gestor']));
    }

    // Regras específicas para isolamento de dados da empresa
    match /empresas/{empresaId} {
      allow read: if request.auth != null && 
        (hasRole(['superadmin', 'adminmaster']) ||
         request.auth.token.empresaId == empresaId ||
         true); // Permitir leitura para verificação de sistemas

      allow write: if request.auth != null && 
        (hasRole(['superadmin', 'adminmaster']) ||
         (request.auth.token.empresaId == empresaId && hasRole(['admin', 'gestor'])) ||
         isAuthenticated()); // Mais permissivo para criação
    }

    // Logs de auditoria da empresa
    match /empresa_audit_logs/{logId} {
      allow read: if request.auth != null && 
        (hasRole(['superadmin', 'adminmaster']) ||
         (resource.data.empresaId == request.auth.token.empresaId && hasRole(['admin', 'gestor'])));

      allow create: if request.auth != null;
    }

    // Dados de sistemas isolados por empresa - permitir acesso empresa
    match /ponto-registros/{registroId} {
      allow read, write: if request.auth != null && 
        (hasRole(['superadmin', 'adminmaster']) || isEmpresaUser() ||
         request.resource.data.empresaId == request.auth.token.empresaId ||
         resource.data.empresaId == request.auth.token.empresaId ||
         sameCompany(request.resource.data.empresaId) ||
         sameCompany(resource.data.empresaId));
    }

    match /chamados/{chamadoId} {
      allow read, write: if request.auth != null && 
        (hasRole(['superadmin', 'adminmaster']) || isEmpresaUser() ||
         request.resource.data.empresaId == request.auth.token.empresaId ||
         resource.data.empresaId == request.auth.token.empresaId ||
         sameCompany(request.resource.data.empresaId) ||
         sameCompany(resource.data.empresaId));
    }

    match /crm-clientes/{clienteId} {
      allow read, write: if request.auth != null && 
        (hasRole(['superadmin', 'adminmaster']) || isEmpresaUser() ||
         request.resource.data.empresaId == request.auth.token.empresaId ||
         resource.data.empresaId == request.auth.token.empresaId ||
         sameCompany(request.resource.data.empresaId) ||
         sameCompany(resource.data.empresaId));
    }

    match /frota-veiculos/{veiculoId} {
      allow read, write: if request.auth != null && 
        (hasRole(['superadmin', 'adminmaster']) || isEmpresaUser() ||
         request.resource.data.empresaId == request.auth.token.empresaId ||
         resource.data.empresaId == request.auth.token.empresaId ||
         sameCompany(request.resource.data.empresaId) ||
         sameCompany(resource.data.empresaId));
    }

    match /financeiro-documentos/{documentoId} {
      allow read, write: if request.auth != null && 
        (hasRole(['superadmin', 'adminmaster']) || isEmpresaUser() ||
         request.resource.data.empresaId == request.auth.token.empresaId ||
         resource.data.empresaId == request.auth.token.empresaId ||
         sameCompany(request.resource.data.empresaId) ||
         sameCompany(resource.data.empresaId));
    }

    match /documentos/{documentoId} {
      allow read, write, create, update, delete: if request.auth != null && (
        hasRole(['superadmin', 'adminmaster']) || 
        isEmpresaUser() ||
        request.auth.token.role == 'empresa' ||
        request.resource.data.empresaId == request.auth.token.empresaId ||
        resource.data.empresaId == request.auth.token.empresaId ||
        request.resource.data.empresaId == request.auth.token.company ||
        resource.data.empresaId == request.auth.token.company ||
        sameCompany(request.resource.data.empresaId) ||
        sameCompany(resource.data.empresaId)
      );
    }
  }
}