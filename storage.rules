rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    // Arquivos por empresa - isolamento completo
    match /empresas/{companyId}/{allPaths=**} {
      allow read, write: if isSuperAdmin();

      // Apenas usuários da mesma empresa
      allow read, write: if isAuthenticated() && 
        sameCompany(companyId) && 
        validFileType() && 
        validFileSize();
    }

    // Documentos específicos por sistema
    match /documentos/{companyId}/{sistema}/{allPaths=**} {
      allow read, write: if isSuperAdmin();

      allow read, write: if isAuthenticated() && 
        sameCompany(companyId) && 
        hasSystemAccess(sistema) && 
        validFileType() && 
        validFileSize();
    }

    // Fotos de perfil
    match /avatars/{userId}/{allPaths=**} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && 
        (request.auth.uid == userId || isSuperAdmin()) && 
        isImageFile() && 
        resource.size < 5 * 1024 * 1024; // 5MB
    }

    // Arquivos públicos (logos, etc)
    match /public/{allPaths=**} {
      allow read: if true;
      allow write: if isSuperAdmin();
    }

    // Backup (apenas superadmin)
    match /backups/{allPaths=**} {
      allow read, write: if isSuperAdmin();
    }

    // Negar tudo o mais
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }

  // ===== FUNÇÕES DE SEGURANÇA =====
  function isSuperAdmin() {
    return request.auth != null && request.auth.token != null && (
      request.auth.token.bootstrapAdmin == true ||
      request.auth.token.role == 'superadmin' ||
      request.auth.token.role == 'adminmaster'
    );
  }

  function isAuthenticated() { 
    return request.auth != null && request.auth.uid != null; 
  }

  function sameCompany(companyId) {
    return request.auth != null && request.auth.token != null && (
      isSuperAdmin() || 
      request.auth.token.empresaId == companyId ||
      request.auth.token.company == companyId
    );
  }

  function hasSystemAccess(sistema) {
    return request.auth != null && request.auth.token != null && (
      isSuperAdmin() ||
      request.auth.token.role == 'admin' ||
      request.auth.token.role == 'gestor' ||
      (request.auth.token.sistemasAtivos != null && 
       sistema in request.auth.token.sistemasAtivos)
    );
  }

  function validFileType() {
    return request.resource.contentType.matches('image/.*') ||
           request.resource.contentType.matches('application/pdf') ||
           request.resource.contentType.matches('text/.*') ||
           request.resource.contentType.matches('application/vnd.ms-excel') ||
           request.resource.contentType.matches('application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
  }

  function isImageFile() {
    return request.resource.contentType.matches('image/.*');
  }

  function validFileSize() {
    return request.resource.size < 50 * 1024 * 1024; // 50MB
  }
}